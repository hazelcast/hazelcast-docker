name: Build OS and EE image

on:
  workflow_dispatch:
    inputs:
      SOURCE_REF:
        description: 'The hazelcast-docker branch to build the image from'
        required: true
      RELEASE_TYPE:
        description: 'What should be built'
        required: true
        type: choice
        options:
          - ALL
          - OSS
          - EE
      HZ_REVISION:
        description: 'Commit id of Hazelcast snapshot jar'
        required: false
      ENVIRONMENT:
        description: 'Environment to use'
        required: true
        type: environment
  workflow_call:
    inputs:
      SOURCE_REF:
        description: 'The hazelcast-docker branch to build the image from'
        required: true
        type: string
      RELEASE_TYPE:
        description: 'What should be built'
        required: true
        type: string
      HZ_REVISION:
        description: 'Commit id of Hazelcast snapshot jar'
        required: false
        type: string
      ENVIRONMENT:
        description: 'Environment to use'
        required: true
        type: string

jobs:
  package:
    uses: ./.github/workflows/tag_image_package.yml
    with:
      SOURCE_REF: ${{ inputs.SOURCE_REF }}
      RELEASE_TYPE: ${{ inputs.RELEASE_TYPE }}
      HZ_REVISION: ${{ inputs.HZ_REVISION }}
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
    secrets: inherit

  promote:
    needs: package
    uses: ./.github/workflows/tag_image_promote.yml
    with:
      VERSION: ${{ inputs.SOURCE_REF }}
      RELEASE_TYPE: ${{ inputs.RELEASE_TYPE }}
      HZ_REVISION: ${{ inputs.HZ_REVISION }}
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
    secrets: inherit
