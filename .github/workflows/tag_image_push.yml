name: Build OS and EE image

on:
  workflow_dispatch:
    inputs:
      SRC_IMAGE_NAME:
        description: 'Name of the source image including tag'
        required: true
      TARGET_IMAGE_NAME:
        description: 'Name of the target image including tag'
        required: true


jobs:
  copy-image:
    runs-on: ubuntu-latest
    env:
      QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
      QUAY_TOKEN: ${{ secrets.QUAY_TOKEN }}
      SRC_IMAGE_NAME: ${{ github.event.inputs.SRC_IMAGE_NAME }}
      TARGET_IMAGE_NAME: ${{ github.event.inputs.TARGET_IMAGE_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to quay.io Docker registry
        run: echo "${QUAY_TOKEN}" | docker login -u "${QUAY_USERNAME}" --password-stdin quay.io

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Pull the source image
        run: docker pull "${SRC_IMAGE_NAME}"

      - name: Tag the target image
        run: docker tag "${SRC_IMAGE_NAME}" "${TARGET_IMAGE_NAME}"

      - name: Push the target image
        run: docker push "${TARGET_IMAGE_NAME}"

      - name: Slack notification
        uses: ./.github/actions/slack-notification
        if: failure()
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK }}