name: Package EE NLC image

on:
  # For debugging only
  workflow_dispatch:
    inputs:
      SOURCE_REF:
        description: 'The hazelcast-docker branch to build the image from'
        required: true
      HZ_REVISION:
        description: 'Commit id of Hazelcast snapshot jar'
        required: false
      ENVIRONMENT:
        description: 'Environment to use'
        required: true
        type: environment
  workflow_call:
    inputs:
      SOURCE_REF:
        description: 'The hazelcast-docker branch to build the image from'
        required: true
        type: string
      HZ_REVISION:
        description: 'Commit id of Hazelcast snapshot jar'
        required: false
        type: string
      ENVIRONMENT:
        description: 'Environment to use'
        required: true
        type: string

jobs:
  prepare:
    uses: ./.github/workflows/tag_image_prepare.yml
    with:
      SOURCE_REF: ${{ inputs.SOURCE_REF }}
      RELEASE_TYPE: EE
      ENVIRONMENT: ${{ inputs.ENVIRONMENT }}

  package-nlc:
    environment: ${{ inputs.ENVIRONMENT }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        jdk: ${{ fromJSON(needs.prepare.outputs.jdks) }}
    env:
      LOCAL_IMAGE_NAME: localhost:5000/${{ secrets.NLC_IMAGE_NAME }}
      DOCKER_DIR: hazelcast-enterprise
      TEST_CONTAINER_NAME: hazelcast-test
    services:
      registry:
        image: registry:latest
        ports:
          - 5000:5000
    steps:
      - uses: actions/checkout@v6

      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.SOURCE_REF }}
          path: source_path
          sparse-checkout: ${{ env.DOCKER_DIR }}

      - name: Setup Docker
        uses: ./.github/actions/setup-docker

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_HAZELCAST_OIDC_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: 'us-east-1'

      - name: Download the distribution file
        id: download-hz-dist
        run: |
          if [[ "${{ needs.prepare.outputs.hz-version }}" =~ SNAPSHOT ]]; then
            subdir=/snapshot
          else
            subdir=
          fi

          S3_NLC_ZIP_URL=${S3_NLC_URL}${subdir}/hazelcast-enterprise-${{ needs.prepare.outputs.hz-version }}-nlc.zip
          OUTPUT_FILE=source_path/${DOCKER_DIR}/hazelcast-enterprise-distribution.zip

          aws s3 cp "${S3_NLC_ZIP_URL}" "${OUTPUT_FILE}" --no-progress

          echo "output_file=${OUTPUT_FILE}" >> "${GITHUB_OUTPUT}"
        env:
          S3_NLC_URL: ${{ secrets.S3_NLC_URL }}

      - id: get-tags-to-push
        uses: ./.github/actions/get-tags-to-push-nlc
        with:
          hz-version: ${{ needs.prepare.outputs.hz-version }}
          jdk: ${{ matrix.jdk }}
          default-jdk: ${{ needs.prepare.outputs.default-jdk }}

      - name: Get supported platforms
        id: platforms
        uses: hazelcast/docker-actions/get-supported-platforms@master
        with:
          dockerfile: ${{ env.DOCKER_DIR }}/Dockerfile
          jdk: ${{ matrix.jdk }}

      - name: Determine labels
        id: labels
        if: ${{ inputs.HZ_REVISION != '' }}
        run: |
          echo "label=hazelcast.revision=${HZ_REVISION}" >> ${GITHUB_OUTPUT}
        env:
          HZ_REVISION: ${{ inputs.HZ_REVISION }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: source_path/${{ env.DOCKER_DIR }}
          labels: ${{ steps.labels.outputs.label }}
          platforms: ${{ steps.platforms.outputs.platforms }}
          push: true
          tags: ${{ env.LOCAL_IMAGE_NAME}}:${{ steps.get-tags-to-push.outputs.primary-tag }}
          build-args: |
            JDK_VERSION=${{ matrix.jdk }}

      - name: Delete the distribution file
        run: |
          # GitHub Actions have limited disk capacity
          # The distribution is large and no longer required now the image has been built
          rm "${{ steps.download-hz-dist.outputs.output_file }}"

      - name: Run smoke test against image
        timeout-minutes: 2
        run: |
          .github/scripts/simple-smoke-test.sh \
            ${LOCAL_IMAGE_NAME}:${{ steps.get-tags-to-push.outputs.primary-tag }} \
            "${TEST_CONTAINER_NAME}" \
            ee \
            "${{ needs.prepare.outputs.hz-version }}" \
            "${{ matrix.jdk }}"
        env:
          HZ_INSTANCETRACKING_FILENAME: instance-tracking.txt

      - uses: hazelcast/docker-actions/assert-image-size@master
        with:
          image: ${{ env.LOCAL_IMAGE_NAME}}:${{ steps.get-tags-to-push.outputs.primary-tag }}

      - name: Get docker logs
        if: ${{ always() }}
        run: |
          docker logs "${TEST_CONTAINER_NAME}" > "docker.log" || true

      - name: Store docker logs as artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: docker-logs-tag-image-push-nlc-${{ steps.get-tags-to-push.outputs.primary-tag }}
          path: docker.log

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_DEV_INFRA_OIDC_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: 'us-east-1'

      - name: Get Secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            NLC/IMAGE_REGISTRY
          parse-json-secrets: true

      - name: Login to NLC registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.NLC_IMAGE_REGISTRY_URL }}
          username: ${{ env.NLC_IMAGE_REGISTRY_USERNAME }}
          password: ${{ env.NLC_IMAGE_REGISTRY_TOKEN }}

      - name: Push image to remote registry
        run: |
          # Skopeo expects HTTPS registry but local is HTTP
          skopeo copy \
            --all \
            --src-tls-verify=false \
            docker://${LOCAL_IMAGE_NAME}:${{ steps.get-tags-to-push.outputs.primary-tag }} \
            docker://${NLC_IMAGE_REGISTRY_URL}/${{ vars.NLC_NAMESPACE }}/${NLC_IMAGE_NAME}-${{ vars.PREPROD_REGISTRY }}:${{ steps.get-tags-to-push.outputs.primary-tag }}
        env:
          NLC_IMAGE_NAME: ${{ secrets.NLC_IMAGE_NAME }}

  failure-notifications:
    name: Failure notification
    if: failure() && github.triggering_actor == 'devOpsHazelcast'
    needs: package-nlc
    uses: ./.github/workflows/slack-notification.yml
    secrets: inherit
