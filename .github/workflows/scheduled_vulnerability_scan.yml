name: Scheduled Vulnerability Scans

on:
    workflow_dispatch:
    schedule:
        - cron: '0 2 * * *'

jobs:
    get-maintenance-versions:
        uses: ./.github/workflows/get-supported-maintenance-versions.yaml

    get-maintenance-branches:
        runs-on: ubuntu-latest
        needs: get-maintenance-versions
        outputs:
            branches: ${{ steps.branches.outputs.maintenance_branches }}
        steps:
          - id: branches
            run: echo "maintenance_branches=$(echo '${{ needs.get-maintenance-versions.outputs.versions }}' | jq --compact-output 'map(. | tostring + ".z")')" >> ${GITHUB_OUTPUT}

    get-branches-to-scan:
        runs-on: ubuntu-latest
        needs: get-maintenance-branches
        outputs:
            branches: ${{ steps.branches.outputs.branches }}
        steps:
          - id: branches
            run: echo "branches=$(echo '${{ needs.get-maintenance-branches.outputs.branches }}' | jq --compact-output '. as $b | ["master"] + $b')" >> ${GITHUB_OUTPUT}

    trigger-vulnerability-scan:
        needs: get-branches-to-scan
        name: Scan ${{ matrix.ref }}
        strategy:
            fail-fast: false
            matrix:
                ref: ${{ fromJSON(needs.get-branches-to-scan.outputs.branches) }}
        uses: ./.github/workflows/vulnerability_scan_subworkflow.yml
        with:
            ref: ${{ matrix.ref }}
        secrets: inherit
