name: Scheduled Vulnerability Scans

on:
    workflow_dispatch:
    schedule:
        - cron: '0 2 * * *'

jobs:
    get-maintenance-versions:
        runs-on: ubuntu-latest
        outputs:
            minimal: ${{ steps.get-maintenance-versions.outputs.versions }}
        steps:
          - id: get-maintenance-versions
          # uses: hazelcast/hazelcast-mono/.github/actions/get-supported-maintenance-versions@DI-349
            uses: JackPGreen/hazelcast-tpm/.github/actions/get-supported-maintenance-versions@DI-349

    get-branches-to-scan:
        runs-on: ubuntu-latest
        needs: get-maintenance-versions
        outputs:
            branches: ${{ steps.branches.outputs.branches }}
        steps:
          - id: branches
            run: |
                # Convert maintenance versions -> Docker branches
                maintenance_branches=$(jq --compact-output 'map(. | tostring + ".z")' <<< '${{ needs.get-maintenance-versions.outputs.versions }}')
                # Add `master`, too
                echo "branches=$(jq --compact-output '. as $b | ["master"] + $b' <<< "$maintenance_branches")" >> ${GITHUB_OUTPUT}

    trigger-vulnerability-scan:
        needs: get-branches-to-scan
        name: Scan ${{ matrix.ref }}
        strategy:
            fail-fast: false
            matrix:
                ref: ${{ fromJSON(needs.get-branches-to-scan.outputs.branches) }}
        uses: ./.github/workflows/vulnerability_scan_subworkflow.yml
        with:
            ref: ${{ matrix.ref }}
        secrets: inherit
