name: Docker Image CI

on:
  pull_request:
    paths-ignore:
      - '**.md'

jobs:
  build:
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        hazelcastImage: [hazelcast-oss, hazelcast-enterprise]
    steps:
    - uses: actions/checkout@v1
    - name: Build the Docker image
      run: docker build -t ${{ matrix.hazelcastImage }} ${{ matrix.hazelcastImage }}
    - name: Verify
      env:
        HAZELCAST_IMAGE: ${{ matrix.hazelcastImage }}
        HZ_LICENSE_KEY: ${{ secrets.HZ_LICENSE_KEY }}
      run: |
        if [ "$HAZELCAST_IMAGE" = "hazelcast-oss" -o -n "$HZ_LICENSE_KEY" ]; then
          docker run --name ${HAZELCAST_IMAGE}-container -e HZ_LICENSE_KEY=$HZ_LICENSE_KEY -d --rm $HAZELCAST_IMAGE
          sleep 10
          HZ_IP=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' ${HAZELCAST_IMAGE}-container)
          nc -z $HZ_IP 5701
        else
          # license key is not available in PRs (to avoid leaking the secret value), lets just check we really run the EE
          docker run --name ${HAZELCAST_IMAGE}-container --rm $HAZELCAST_IMAGE 2>&1 | grep -q "Hazelcast Enterprise"
        fi
